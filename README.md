# Basis-Zero: Yield-Funded Prediction Market

Basis-Zero is a capital-efficient prediction market that eliminates the opportunity cost of betting. By integrating **Real-World Asset (RWA)** yields directly into the collateral vault, users can trade prediction markets using only the yield generated by their idle capital ("Safe Mode") or leverage their full principal for higher stakes ("Full Mode").

This project creates a seamless bridge between **DeFi Yield** (via RWA simulation) and **High-Frequency Trading** (via simulated Yellow Network state channels).

---

## ğŸš€ Core Features

### 1. The Yield Vault
- **Principal Protection**: Funds deposited into the `SessionEscrow` contract immediately start earning yield (simulating BlackRock BUIDL or similar RWA tokens).
- **Real-Time Accrual**: Yield is calculated second-by-second on-chain and visualized in real-time on the frontend.
- **Auto-Compounding**: Yield is tracked separately but can be utilized as margin.

### 2. Trading Modes
- **ğŸ›¡ï¸ Safe Mode (No-Loss Trading)**:
    - Users can only bet with their *accrued yield*.
    - The principal balance remains strictly locked and safe.
    - If a user loses a bet, it only reduces their yield balance.
- **âš¡ Full Mode**:
    - Users can bet with both their *principal and yield*.
    - Allows for larger position sizing.
    - Losses first eat into yield, then into principal.

### 3. AMM Prediction Markets
- **Binary Markets**: YES/NO outcome shares.
- **Automated Market Maker**: Constant Product Market Maker (CPMM) logic running off-chain for instant execution.
- **Order Book UI**: Real-time price updates and trade execution.

---

## ğŸ—ï¸ Architecture Overview

The system consists of three main components working in sync:

### 1. Smart Contracts (Polygon Amoy)
*   **`SessionEscrow.sol`**: The core on-chain component.
    *   **Custody**: Holds user USDC deposits.
    *   **Yield Engine**: Calculates linear yield based on a configurable BPS rate (e.g., 5200 bps = 52% APY).
    *   **Session Locking**: "Locks" funds when a user enters a trading session, preventing withdrawal during active trading.
    *   **Settlement**: Verifies backend signatures (Nitrolite) to settle trading PnL trustlessly.

### 2. Backend (Node.js / Express)
*   **Session Manager**: Orchestrates the "Open Session" and "Close Session" flows.
*   **Off-Chain AMM**: Manages the order book and matches trades locally during the active session. This simulates the high-speed performance of the Yellow Network.
*   **Signer Service**: Acts as the Yellow Network authority, signing final settlement payloads that the smart contract verifies.

### 3. Frontend (Next.js)
*   **Real-Time UI**: Uses `wagmi` and `viem` for blockchain interaction.
*   **Streaming Balances**: Visualizes yield growing in real-time.
*   **Dual-Mode Interface**: Toggles seamlessly between Safe Mode and Full Mode.

---

## ğŸŸ¡ Yellow Network Integration (Architecture)

Basis-Zero leverages the **Yellow Network** architecture model for high-speed, gasless trading sessions that settle on-chain.

### The "Session" Model
Instead of executing every trade on-chain (slow, expensive), we use a **Session-based** approach:

1.  **Open Session (On-Chain)**:
    *   User calls `openSession(amount)` on `SessionEscrow`.
    *   Contract "locks" the specified amount (Principal + Yield).
    *   Contract emits `SessionOpened`.

2.  **Trade (Off-Chain / Yellow Network)**:
    *   The backend (simulating Yellow Nodes) detects the session.
    *   User signs orders off-chain (fast, 0 gas).
    *   The AMM updates the user's "Virtual Balance" instantly.
    *   Zero gas fees for individual trades.

3.  **Close & Settle (On-Chain)**:
    *   User requests to close the session.
    *   The backend calculates the final PnL (Profit/Loss).
    *   Backend (Nitrolite Signer) **signs** the final result.
    *   User (or Relayer) calls `settleSession(pnl, signature)` on-chain.
    *   Contract verifies the signature and updates the user's on-chain balance (Principal +/- PnL).

#### Session Sequence Diagram
```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant SessionEscrow as Contract
    participant Backend as Yellow Node

    User->>Frontend: Connect Wallet
    User->>Frontend: Deposit USDC
    Frontend->>SessionEscrow: deposit(amount)
    SessionEscrow-->>Frontend: Deposited

    rect rgb(20, 20, 20)
        Note right of User: Session Start
        User->>Frontend: Open Session
        Frontend->>SessionEscrow: openSession(amount)
        SessionEscrow-->>Backend: Event: SessionOpened
        Backend->>Backend: Initialize Session State
    end

    rect rgb(30, 30, 30)
        Note right of User: High Frequency Trading
        loop Trading Loop
            User->>Frontend: Place Bet (Safe/Full Mode)
            Frontend->>Backend: Sign Order (Off-chain)
            Backend->>Backend: Match Trade & Update PnL
            Backend-->>Frontend: Stream New Balance
        end
    end

    rect rgb(20, 20, 20)
        Note right of User: Settlement
        User->>Frontend: Close Session
        Frontend->>Backend: Request Settlement
        Backend->>Backend: Calculate Final PnL
        Backend-->>Frontend: Return {pnl, signature}
        Frontend->>SessionEscrow: settleSession(sessionId, pnl, sig)
        SessionEscrow->>SessionEscrow: Verify Sig & Update Balance
        SessionEscrow-->>Frontend: SessionSettled
    end
```

### System Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Frontend (Web)                â”‚
â”‚                                              â”‚
â”‚ - Wallet connect                             â”‚
â”‚ - Deposit USDC                               â”‚
â”‚ - Open Yield-Only Session                    â”‚
â”‚ - Place instant bets                         â”‚
â”‚ - End session                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ wallet signatures
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Yellow SDK (Client Side)          â”‚
â”‚                                              â”‚
â”‚ - Creates Nitrolite session                  â”‚
â”‚ - Signs off-chain state updates              â”‚
â”‚ - Streams bet intents                        â”‚
â”‚ - Displays live yield + PnL                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ off-chain state transitions
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Yellow Network (Nitrolite)           â”‚
â”‚                                              â”‚
â”‚ Enforced Session State:                      â”‚
â”‚                                              â”‚
â”‚ principal_locked = deposit                   â”‚
â”‚ yield_accrued = P Ã— r Ã— Î”t (contract)        â”‚
â”‚ pnl = realized bet results                   â”‚
â”‚ max_loss = yield_accrued                     â”‚
â”‚                                              â”‚
â”‚ RULES (hard enforced):                       â”‚
â”‚ - principal cannot be spent                  â”‚
â”‚ - pnl â‰¥ -yield_accrued                       â”‚
â”‚ - session freezes if violated                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ oracle resolution
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Market Oracle (Mock / Simple)        â”‚
â”‚                                              â”‚
â”‚ - Resolves event outcome                     â”‚
â”‚ - Signs result                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ final state proof
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Settlement Contract (Polygon)            â”‚
â”‚                                              â”‚
â”‚ - Holds USDC                                 â”‚
â”‚ - Verifies final Yellow state                â”‚
â”‚ - Returns principal                          â”‚
â”‚ - Applies yield PnL                          â”‚
â”‚                                              â”‚
â”‚ ONLY TWO TXs:                                â”‚
â”‚ 1. Deposit                                   â”‚
â”‚ 2. Final Settlement                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Security
*   **Signature Verification**: The `SessionEscrow` contract holds a list of `trustedNitroliteSigners`. Settlements are only accepted if signed by a trusted authority.
*   **Timeouts**: If the off-chain network goes down, users can trigger a `timeoutRelease` after 24 hours to recover their locked funds.

---

## ğŸ› ï¸ Tech Stack

*   **Frontend**: Next.js 14, TailwindCSS, Shadcn/UI, Wagmi, Viem, Framer Motion.
*   **Backend**: Node.js, Express, Ethers.js.
*   **Blockchain**: Polygon Amoy Testnet.
*   **Contracts**: Solidity 0.8.24, OpenZeppelin.

## ğŸ Getting Started

### Prerequisites
*   Node.js v18+
*   Wallet with Polygon Amoy MATIC (for gas) and USDC (for testing).

### 1. Contracts
```bash
cd contracts
npm install
npx hardhat run scripts/deploy-session.ts --network amoy
```

### 2. Backend
```bash
cd backend
# Create .env from .env.example and add your Private Key (SIGNER_PRIVATE_KEY)
npm install
npm run dev
```

### 3. Frontend
```bash
cd frontend
# Create .env and add NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID
npm install
npm run dev
```

Visit `http://localhost:3000` to start trading!
